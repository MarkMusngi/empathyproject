<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Interview Feedback</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: auto; }
        h1, h2, h3 { color: #333; }
        .feedback-box { border: 1px solid #ccc; border-radius: 6px; padding: 16px; background: #f9f9f9; }
        .metric { margin-bottom: 10px; }
        .status { margin-top: 10px; font-size: 0.9em; color: #666; }
    </style>
</head>
<body>
    <h1>Interview Feedback</h1>
    <div>
        <h3>Question:</h3>
        <p>{{ question }}</p>

        <h3>Your Answer:</h3>
        <p>{{ answer }}</p>

        <h3>Detected Emotion:</h3>
        <p>{{ emotion }}</p>

        <h3>Role Level:</h3>
        <p>{{ role_level|capfirst }}</p>

        <h3>Category:</h3>
        <p>{{ category|capfirst }}</p>
    </div>

    <div class="feedback-box">
        <h3>Feedback Summary</h3>
        <pre>{{ feedback }}</pre>
    </div>

    {% if metrics %}
        <div>
            <h3>Performance Metrics:</h3>
                {% for key, value in metrics.items %}
                    <div class="metric"><strong>{{ key|capfirst }}</strong>: {{ value }}</div>
                {% endfor %}
        </div>
    {% endif %}

    <div class="status">
        Vectorizer: 
        {% if vectorizer_available %}
            ✅ Active
        {% else %}
            ⚠️ Not Available (Fallback Mode)
        {% endif %}
        <br>
        Feedback Type: {{ feedback_type }}<br>
        Processing Time: {{ processing_time }}
    </div>
    <div class="emotion-validation">
        <h3>Emotion Analysis:</h3>
        {% if validation_details %}
            <div class="validation-details">
                <p><strong>Detected:</strong> {{ validation_details.original_emotion }}</p>
                <p><strong>Validated:</strong> {{ validation_details.validated_emotion }} 
                ({{ validation_details.confidence_score|floatformat:1 }}% confidence)</p>
                
                {% if validation_details.flags %}
                    <div class="validation-flags">
                        <p><strong>Analysis Notes:</strong></p>
                        <ul>
                            {% for flag in validation_details.flags %}
                                <li>{{ flag }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                {% endif %}
                
                <p><strong>Context:</strong> {{ validation_details.contextual_interpretation }}</p>
                
                {% if validation_details.adjustment_reason != "No adjustment needed" %}
                    <p><strong>Adjustment:</strong> {{ validation_details.adjustment_reason }}</p>
                {% endif %}
            </div>
        {% else %}
            <p>{{ emotion }} (Basic detection)</p>
        {% endif %}
        
        <!-- Emotion correction form -->
        {% if validator_available %}
            <div class="emotion-correction">
                <p>Was this emotion detection accurate?</p>
                <form id="emotion-correction-form">
                    <select name="corrected_emotion">
                        <option value="">Select correct emotion...</option>
                        <option value="neutral">Neutral</option>
                        <option value="happy">Happy</option>
                        <option value="sad">Sad</option>
                        <option value="angry">Focused/Intense</option>
                        <option value="fear">Nervous</option>
                        <option value="surprise">Surprised</option>
                    </select>
                    <button type="submit">Submit Correction</button>
                </form>
            </div>
        {% endif %}
    </div>

    <!-- Add this JavaScript before closing </body> tag -->
    <script>
    // Emotion correction handling
    document.getElementById('emotion-correction-form')?.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const correctedEmotion = this.corrected_emotion.value;
        if (!correctedEmotion) return;
        
        fetch('/correct-emotion/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: `original_emotion={{ emotion }}&corrected_emotion=${correctedEmotion}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Thank you for the feedback! This helps improve emotion detection.');
                this.style.display = 'none';
            }
        })
        .catch(error => console.error('Correction failed:', error));
    });

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    </script>

</body>
</html>