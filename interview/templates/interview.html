{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Interview</title>
    <link rel="stylesheet" href="{% static 'interview.css' %}">
</head>
<body>
    <div class="container">
        <h1>Mock Interview</h1>

        <div class="question-section">
            <h2>Interview Question:</h2>
            <p class="question-text">{{ question }}</p>
        </div>

        <div class="video-section">
            <video id="webcam" autoplay muted></video>
        </div>

        <div class="controls">
            <button class="btn start" onclick="startRecognition()">Start Answer</button>
            <button class="btn stop" onclick="stopRecognition()">Finish Answer</button>
        </div>

        <div class="status-section">
            <p id="status">Status: Idle</p>
            <p id="transcript-output"></p>
        </div>

        
        <div class="role-selection">
            <label for="role_level">Select Role Level:</label>
            <select name="role_level" id="role_level">
                <option value="junior" {% if role_level == 'junior' %}selected{% endif %}>Junior</option>
                <option value="mid" {% if role_level == 'mid' %}selected{% endif %}>Mid</option>
                <option value="senior" {% if role_level == 'senior' %}selected{% endif %}>Senior</option>
                <option value="lead" {% if role_level == 'lead' %}selected{% endif %}>Lead</option>
            </select>
        </div>


        <form id="transcribe-form" action="{% url 'feedback_page' %}" method="get">
            <input type="hidden" name="transcript" id="transcript-input">
            <button type="submit" id="goto-feedback" style="display: none;">Go to Feedback</button>
        </form>
    </div>

    <script>
        const statusEl = document.getElementById("status");
        const outputEl = document.getElementById("transcript-output");
        const inputEl = document.getElementById("transcript-input");

        let recognition;
        let finalTranscript = "";
        let lastTextUpdate = 0;
        let currentTranscript = "";

        function updateAnswerText() {
            const now = Date.now();
            if (now - lastTextUpdate > 2000 && currentTranscript.length > 10) { // Update every 2 seconds
                fetch('/update-answer-text/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: 'text=' + encodeURIComponent(currentTranscript)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.validated_emotion) {
                        console.log('Emotion validated:', data.validated_emotion, 'Confidence:', data.confidence);
                        if (data.flags && data.flags.length > 0) {
                            console.log('Validation flags:', data.flags);
                        }
                    }
                })
                .catch(error => console.log('Validation update failed:', error));
                
                lastTextUpdate = now;
            }
        }

        function startRecognition() {
            if (!('webkitSpeechRecognition' in window)) {
                statusEl.innerText = "Speech recognition not supported in this browser.";
                return;
            }

            recognition = new webkitSpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';

            finalTranscript = "";
            statusEl.innerText = "Listening...";

            recognition.onresult = function(event) {
                let interimTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript + ' ';
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }

                currentTranscript = finalTranscript + interimTranscript;
                
                outputEl.innerText = currentTranscript;
                inputEl.value = finalTranscript.trim();
                
                // Update answer text for real-time validation
                updateAnswerText();
            };

            recognition.onerror = function(event) {
                statusEl.innerText = "❌ Error: " + event.error;
            };

            recognition.onend = function() {
                statusEl.innerText = "✅ Finished.";
                document.getElementById("goto-feedback").style.display = "inline";
            };

            recognition.start();
        }

        function stopRecognition() {
            if (recognition) {
                recognition.stop();
            }
        }

        navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
            document.getElementById('webcam').srcObject = stream;
        }).catch(err => {
            console.error("Webcam error:", err);
        });

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        function checkEmotionStatus() {
            fetch('/emotion-status/')
            .then(response => response.json())
            .then(data => {
                if (data.validated_emotion && data.validated_emotion !== 'neutral') {
                    const statusEl = document.getElementById('emotion-status');
                    if (statusEl) {
                        statusEl.innerText = `Emotion: ${data.validated_emotion} (${Math.round(data.confidence * 100)}% confidence)`;
                    }
                }
            })
            .catch(error => console.log('Emotion status check failed:', error));
        }

        // Check emotion status every 5 seconds
        setInterval(checkEmotionStatus, 5000);
    </script>
</body>
</html>
